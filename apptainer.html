<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Apptainer Configuration - distribute-docs</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="install.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="overview.html"><strong aria-hidden="true">3.</strong> Overview</a></li><li class="chapter-item expanded "><a href="configuration.html"><strong aria-hidden="true">4.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="apptainer.html" class="active"><strong aria-hidden="true">4.1.</strong> Apptainer Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="apptainer-introduction.html"><strong aria-hidden="true">4.1.1.</strong> Apptainer Overview</a></li><li class="chapter-item expanded "><a href="apptainer-mutable-filesystem.html"><strong aria-hidden="true">4.1.2.</strong> Mutable Filesystem</a></li><li class="chapter-item expanded "><a href="apptainer-input-files.html"><strong aria-hidden="true">4.1.3.</strong> Input Files</a></li><li class="chapter-item expanded "><a href="apptainer-storing-results.html"><strong aria-hidden="true">4.1.4.</strong> Storing Results</a></li><li class="chapter-item expanded "><a href="apptainer-packaging-solvers.html"><strong aria-hidden="true">4.1.5.</strong> Packaging Solvers</a></li><li class="chapter-item expanded "><a href="apptainer-running-locally.html"><strong aria-hidden="true">4.1.6.</strong> Running Locally</a></li></ol></li><li class="chapter-item expanded "><a href="python.html"><strong aria-hidden="true">4.2.</strong> Python Jobs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="python-build-scripts.html"><strong aria-hidden="true">4.2.1.</strong> Build Scripts</a></li><li class="chapter-item expanded "><a href="python-input-files.html"><strong aria-hidden="true">4.2.2.</strong> Input Files</a></li><li class="chapter-item expanded "><a href="python-storing-results.html"><strong aria-hidden="true">4.2.3.</strong> Storing Results</a></li><li class="chapter-item expanded "><a href="python-execution-scripts.html"><strong aria-hidden="true">4.2.4.</strong> Execution Scripts</a></li><li class="chapter-item expanded "><a href="python-full-example.html"><strong aria-hidden="true">4.2.5.</strong> Full Example</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="commands.html"><strong aria-hidden="true">5.</strong> Command Basics</a></li><li class="chapter-item expanded "><a href="python_api.html"><strong aria-hidden="true">6.</strong> Python Api</a></li><li class="chapter-item expanded "><a href="capabilities.html"><strong aria-hidden="true">7.</strong> Capabilities</a></li><li class="chapter-item expanded "><a href="admin_setup.html"><strong aria-hidden="true">8.</strong> Admin Setup</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="head_node_setup.html"><strong aria-hidden="true">8.1.</strong> Head Node Setup</a></li><li class="chapter-item expanded "><a href="compute_node_setup.html"><strong aria-hidden="true">8.2.</strong> Compute Node Setup</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">distribute-docs</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="apptainer"><a class="header" href="#apptainer">Apptainer</a></h1>
<h2 id="configuration-file"><a class="header" href="#configuration-file">Configuration File</a></h2>
<p>A default configuration file can be generated with :</p>
<pre><code>distribute template apptainer
</code></pre>
<pre><code class="language-yaml">---
meta:
  batch_name: your_jobset_name
  namespace: example_namespace
  matrix: ~
  capabilities:
    - apptainer
    - gpu
apptainer:
  initialize:
    sif: 
	  path: execute_container.sif
    required_files:
      - path: /file/always/present/1.txt
        alias: optional_alias.txt
      - path: /another/file/2.json
        alias: ~
      - path: /maybe/python/utils_file.py
        alias: ~
    required_mounts:
      - /path/inside/container/to/mountL
  jobs:
    - name: job_1
      required_files:
        - path: job_configuration_file.json
          alias: ~
        - path: job_configuration_file_with_alias.json
          alias: input.json
</code></pre>
<h3 id="meta-section"><a class="header" href="#meta-section"><code>meta</code> section</a></h3>
<p>The <code>meta</code> section is identical to the <code>meta</code> section of python. </p>
<p>The <code>namespace</code> field is a string that describes all of the <code>batch_name</code>s that 
are a part of this <code>namespace</code>.</p>
<p>The <code>batch_name</code> is an a simple string to identify what jobs are in this batch.</p>
<p>If your <code>distribute</code> cluster has been configured by your adminstrator for matrix support, 
you can specify the <code>matrix</code> field to be your matrix username in the form of <code>@your-user:matrix.org</code>
and you will receive a message when all of the jobs in this job batch finish.</p>
<p>The <code>capabilities</code> section is a list of dependencies that are required to be present on the compute node.
Since you are responsible for bundling all your dependencies in your apptainer image, the only capabilities
requires here are <code>apptainer</code>. If you require a GPU on the compute node, you can also specify the <code>gpu</code>
capability.</p>
<p>On the server, each <code>batch_name</code> must be unique to each <code>namespace</code>. This means the results of submitting
two batches of batch name <code>name_xyz</code> with identical namespaces is undefined. This is because on
the server each batch name is a subdirectory of the namespace. For example, if we have run
two job batches <code>job_batch_01</code> and <code>job_batch_02</code> under the namespace <code>example_namespace</code>,
the directory structure might look like </p>
<pre><code>example_namespace/
├── job_batch_01
│   ├── job_1
│   │   └── stdout.txt
│   ├── job_2
│   │   └── stdout.txt
│   └── job_3
│       └── stdout.txt
└── job_batch_02
    ├── job_1
    │   └── stdout.txt
    ├── job_2
    │   └── stdout.txt
    └── job_3
        └── stdout.txt
</code></pre>
<p>For example, if I am running many aeroacoustic studies with OpenFoam, a namespace might be 
<code>austin_openfoam_aeroacoustic</code>, and then I run batches with incremented names,
<code>supersonic_aeroacoustic_00X</code>, <code>subsonic_aeroacoustic_00X</code>, <code>transsonic_aeroacoustic_00X</code>. My <code>meta</code>
section for one of these job batches would look like:</p>
<pre><code>meta:
  batch_name: subsonic_aeroacoustic_004
  namespace: austin_openfoam_aeroacoustic
  matrix: @my-username:matrix.org
  capabilities:
    - apptainer
    - gpu
</code></pre>
<h3 id="apptainer-section"><a class="header" href="#apptainer-section"><code>apptainer</code> section</a></h3>
<p>the <code>apptainer</code> section has two subsections: <code>initialize</code> which handles the setup of the solver
and <code>jobs</code> which specifies a list of jobs that are part of this job batch.</p>
<h3 id="initialize-section"><a class="header" href="#initialize-section"><code>initialize</code> section</a></h3>
<p>The <code>sif</code> key contains a <code>path</code> to a <code>.sif</code> file that was constructed from <code>apptainer build</code>.
Information on building these <code>.sif</code> files is available <a href="./apptainer-introduction.html">here</a>.
Ensure that you <code>.sif</code> file also contains the correct <code>%apprun distribute</code> interface.</p>
<p>The <code>required_files</code> contains a list of files, each file with a <code>path</code> and <code>alias</code>.
The <code>path</code> is a path to a file on disk, and the <code>alias</code> is a filename as it will appear
in the <code>/input</code> directory of your <code>.sif</code> solver when executed. A more in-depth 
explanation of this behavior is available in the <a href="./apptainer-input-files.html">input files section</a></p>
<p><code>required_mounts</code> provides a way to create mutable directories in your container from within a compute 
node. Ensure that this directory does not exist in this container since it will be created at runtime.
More information on binding volumes (and creating mutable directories) is found <a href="./apptainer-mutable-filesystem.html">here</a>.</p>
<h3 id="jobs"><a class="header" href="#jobs"><code>jobs</code></a></h3>
<p>This field contains the list of jobs and the locations of their input files on disk.
For each job, there are two configuration keys:</p>
<p><code>name</code>: the name of the job in this batch. Job names must be unique to the <code>batch_name</code> field from
the <code>meta</code> section: there cannot be two jobs with the same name in the same batch. </p>
<p><code>required_files</code>: a list of files, each containing a <code>path</code> key and optional <code>alias</code> key. These
files are identical in configuration to the <code>required_files</code> from the <code>initialize</code> field above.
Each file has <code>path</code> (a location on disk) and an optional <code>alias</code> field, or the name of the file 
as it will be represented in the <code>/input</code> directory when that job is run.</p>
<p>For example, if the jobs section of the config file contained</p>
<pre><code>	jobs:
	- name: job_1
	  required_files:
		- path: job_configuration_file.json
		  alias: ~
		- path: job_configuration_file_with_alias.json
		  alias: input.json
</code></pre>
<p>then this batch would have one job named <code>job_1</code>. When this job is executed, the <code>/input</code> directory of
the apptainer image will contain a file <code>job_configuration_file.json</code> and <code>input.json</code> since the 
second file was aliased. Additionally, any files specified in the <code>required_files</code> of the <code>initialize</code>
section will also be present in the <code>/input</code> directory.</p>
<h2 id="workflow-differences-from-python"><a class="header" href="#workflow-differences-from-python">Workflow Differences From Python</a></h2>
<p>The largest difference you will encounter between the apptainer and python configurations is the way in
which they are executed. While each python job has its own file that it may use for execution, the apptainer
workflow simply relies on whatever occurs in <code>%apprun distribute</code> to read files from <code>/input</code> and execute the 
binary directly. Therefore, each job in the configuration file only operates on some additional input files 
and the <code>.sif</code> file never changes. This is slightly less flexible than the python configuration (which allows
for individual python files to run each job), but by storing your input files in some intermediate structure
(like json) this difficulty can be easily overcome.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="configuration.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="apptainer-introduction.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="configuration.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="apptainer-introduction.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
